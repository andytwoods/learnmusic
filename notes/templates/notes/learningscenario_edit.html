{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
  Learning Scenario
{% endblock %}

{% block content %}

  {{ instruments_info|json_script:"instruments-data" }}


  <div class="row justify-content-center align-items-center mb-5">
    <div class="col-md-8">
      <h2>Your Learning Scenario</h2>
      <p>
        Please select your instrument. The level you select will determine the range of notes you will
        practice with. {% if new %}You can edit these notes after saving this form for the first time.{% else %}You can
        <a href="{% url 'edit-learning-scenario-notes' pk=learningscenario_pk %}">edit</a>
        these notes.{% endif %}
      </p>
            <div class="mb-3">
          <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#advanced-collapse" aria-expanded="false" aria-controls="advanced-collapse">
            Advanced Options
          </button>
        </div>
        {% crispy form %}

    </div>
  </div>

  <script>
    const instruments_info = JSON.parse(
      document.getElementById('instruments-data').textContent
    );


    document.addEventListener('DOMContentLoaded', function () {
      const instrumentSelect = document.getElementById('id_instrument_name');
      const clefSelect = document.getElementById('id_clef');
      const keySelect = document.getElementById('id_key');
      const levelSelect = document.getElementById('id_level');
      // Advanced options toggle button
      const advancedButton = document.querySelector('[data-bs-target="#advanced-collapse"]');
      const advancedCollapse = document.getElementById('advanced-collapse');

      // Function to handle level changes
      const handleLevelChange = () => {
        // If level is Beginner, we don't need to do anything special
        // The transpose_key field is already in the advanced section
        // which will be hidden/shown with the Advanced Options button
      };

      // Add event listener for level changes
      levelSelect.addEventListener('change', handleLevelChange);

      // Call on page load to set initial state
      handleLevelChange();

      const updateFields = () => {
        let selectedInstrumentText = instrumentSelect.options[instrumentSelect.selectedIndex].text;

        const instrumentInfo = instruments_info[selectedInstrumentText];

        if (instrumentInfo) {

          const clefs = instrumentInfo.clef; // Get clef options
          const keys = instrumentInfo.common_keys; // Get key options

          if (clefs.length > 0) {
            const firstClef = clefs[0].toUpperCase(); // Get the first clef (convert to uppercase for comparison)
            for (const option of clefSelect.options) {
              if (option.value.toUpperCase() === firstClef) {
                clefSelect.value = option.value; // Match found; set it as selected
                break;
              }
            }
          }

          if (keys.length > 0) {

            keySelect.value = keys[0];
          }
        }
      };

      // Event listener for instrument dropdown changes
      instrumentSelect.addEventListener('change', updateFields);


      if (window.location.search.includes('?new=true')) {
        updateFields();
      }

    });
  </script>
{% endblock content %}
