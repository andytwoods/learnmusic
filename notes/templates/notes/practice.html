{% extends 'base.html' %}
{% load static %}


{% block javascript %}
  {{ block.super }}
  <script src="{% static 'js/vexflow.js' %}"></script>
{% endblock javascript %}

{% block title %}
  {{ instrument }} note trainer{% if key %}, {{ key }}{% endif %}
{% endblock %}



{% block body %}

  <div class="position-fixed start-0 end-0 text-center" style="z-index: 1050; top: 20%; pointer-events: none; display: none;">
    <div id="error-message"
         class="draggable d-inline-block text-center text-white p-2 rounded shadow"
         style="display: none; pointer-events: auto; background-color: rgba(220, 53, 69, 0.85)!important;">
      <h2>o o p s</h2>
      <p id="correct-answer"></p>
      <div id="note-guess-ui" style="display:none;" class="mt-2">
        <div class="fw-bold">Identify the note letter (optional)</div>
        <div class="d-flex justify-content-center align-items-center gap-2 mt-2 flex-wrap">
          <div id="note-guess-buttons" class="d-flex flex-row flex-wrap align-items-center gap-2" aria-label="Note letters">
            <button type="button" class="btn btn-light btn-sm note-guess-btn" data-note="C">C</button>
            <button type="button" class="btn btn-light btn-sm note-guess-btn" data-note="D">D</button>
            <button type="button" class="btn btn-light btn-sm note-guess-btn" data-note="E">E</button>
            <button type="button" class="btn btn-light btn-sm note-guess-btn" data-note="F">F</button>
            <button type="button" class="btn btn-light btn-sm note-guess-btn" data-note="G">G</button>
            <button type="button" class="btn btn-light btn-sm note-guess-btn" data-note="A">A</button>
            <button type="button" class="btn btn-light btn-sm note-guess-btn" data-note="B">B</button>
          </div>
          <button id="note-guess-submit" class="btn btn-light btn-sm ms-2">Check</button>
        </div>
        <div id="note-guess-feedback" class="mt-2"></div>
        <div class="small mt-1">Press Space to skip</div>
      </div>
    </div>
  </div>

  <div id='correct-message'
       class="position-fixed start-50 translate-middle-x text-center bg-success text-white p-2 rounded shadow"
       style="z-index: 1050; top: 5%; display: none;">
    <h2 class="m-0"><i class="fas fa-check"></i></h2>
  </div>

  <div class="card w-100 mw-md-75 mx-auto pb-5 d-flex flex-column bg-white"
       style="min-height: calc(var(--vh, 1vh) * 100);">
    <div class="card-header d-flex justify-content-between">
      {% block cardheader %}
        <div>
          <h5 class="d-inline">
            {% if label %}
              {{ label }}
            {% else %}
              {{ instrument }}
            {% endif %}
            {{ key }}{% if key != absolute_pitch %}, absolute pitch {{ absolute_pitch }}{% endif %}
          </h5>
        </div>
        {% include 'notes/components/practice_dropdown_menu_right.html' %}

      {% endblock cardheader %}
    </div>
    <div class="card-body position-relative d-flex flex-column">
      {% block cardbody %}{% endblock %}

      <div id="counter"
           class=" position-absolute top-0 start-0 p-2 m-2 z-1">
        <span id="counter-value">{{ response_count }} notes to be shown</span>

        {% block timeup %}
          {% include 'notes/components/_timeup.html' %}
        {% endblock timeup %}

      </div>
      <div class="text-center {{ score_css }}">

        <div class="text-center" id="sheet-container">
          <div class="draggable" id="sheet"></div>
          <!-- Stave magnification controls -->
        </div>
        <div id="right-of-sheet-placeholder"></div>

      </div>
      {% include instrument_template %}
    </div>
    <div id="cardbottom"></div>
    {% block cardbottom %}{% endblock %}

    <div class="position-absolute bottom-0 end-0 p-3">
      {% include 'notes/components/toggle_help.html' %}
    </div>

  </div>

  {% block saveResult %}
    <script>
      function saveResult(note, reactionTime, correct) {

        {% if package_id %}
          fetch("{% url 'practice-data' package_id=package_id %}", {
            method: 'POST', // HTTP method
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': "{{ csrf_token }}"
            },
            body: JSON.stringify({
              note: note.note,
              alter: note.alter,
              octave: note.octave,
              reaction_time: reactionTime,
              correct: correct
            })
          });
        {% endif %}
      }
    </script>
  {% endblock saveResult %}

  {{ progress|json_script:"progress-data" }}

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Load full instrument definition (ranges, clefs, fingerings)
      if (typeof getInstrumentFullData === "function") {
        getInstrumentFullData('{{ answers_json }}', function (_instrument_full_data) {
          document.instrument_full_data = _instrument_full_data;
          // Maintain backward compatibility: instrument_data holds fingerings map
          document.instrument_data = _instrument_full_data.fingerings || _instrument_full_data;
          try { document.dispatchEvent(new Event('instrumentdata:ready')); } catch (_) {}
        });
      } else if (typeof getInstrumentData === "function") {
        // Fallback for older cached JS: fetch fingerings only and synthesize minimal full data
        getInstrumentData('{{ answers_json }}', function (_instrument_data) {
          document.instrument_data = _instrument_data || {};
          document.instrument_full_data = { fingerings: document.instrument_data };
          try { document.dispatchEvent(new Event('instrumentdata:ready')); } catch (_) {}
        });
      }
    });

    window.progress_data = JSON.parse(
      document.getElementById('progress-data').textContent);

  </script>
  {% block load_progress_data_from_cache %}
  {% endblock load_progress_data_from_cache %}

  <script>
    {% include 'js/stave_manager.js' %}
    {% include 'js/signature_manager.js' %}
    {% include 'js/feedback_manager.js' %}
    feedback_manager.set_response_count({{ response_count }});
    {% include 'js/trial_manager.js' %}
    {% include 'js/session_manager.js' %}

    {% if level|lower == 'beginner' %}
      {% include 'js/learning_manager.js' %}
      //overriding here
      session_manager.next_note = function () {
        const next_note = learning_manager.next_note();
        session_manager.current_note = next_note;
        return next_note;
      }
    {% endif %}

    document.addEventListener("DOMContentLoaded", function () {
      window.special_condition = 'first_trial';
      trial_manager.next();
    });
  </script>

  <script>
    function setViewportHeight() {
      // Calculate 1% of the actual viewport height
      const vh = window.innerHeight * 0.01;
      // Set the custom CSS variable --vh
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    // Run on page load
    setViewportHeight();

    // Optional: Update on window resize (for responsive effects)
    window.addEventListener('resize', setViewportHeight);
  </script>

{% endblock body %}
