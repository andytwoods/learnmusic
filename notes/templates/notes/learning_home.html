{% extends 'base.html' %}

{% block title %}
  Learning manager
{% endblock %}

{% block css %}
  {{ block.super }}
  <style>
    .btn-divider {
      width: 4px;
      background-color: #ddd; /* Divider color */
      display: inline-block; /* Keeps the divider inline with buttons */
    }
  </style>
{% endblock css %}

{% block content %}
  <div class="row justify-content-center align-items-center">
    <div class="col-6 text-center g-2 mb-3">
      <h2>Learning Manager</h2>
    </div>
  </div>
  <div class="row mb-3 justify-content-center align-items-center" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    {% for learningscenario in learningscenarios %}
      <div class="col-md-6" id="learningscenario-{{ learningscenario.id }}">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">
              {% if learningscenario.label %}{{ learningscenario.label }}{% else %}
                {{ learningscenario.instrument_name }} {{ learningscenario.key }}
              {% endif %}
              <div class="dropdown position-absolute top-0 end-0 m-1">
                <button
                  class="btn btn-sm dropdown-toggle"
                  type="button"
                  id="dropdownMenuButton{{ learningscenario.id }}"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Options
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ learningscenario.id }}">
                  <li>
                    <a class='dropdown-item' href="{% url 'edit-learning-scenario' pk=learningscenario.id %}">Edit
                      learning scenario</a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{% url 'edit-learning-scenario-notes' pk=learningscenario.id %}">
                      Edit notes</a>
                  </li>
                  <li>
                    <a class="dropdown-item"
                       hx-post="."
                       hx-no-confirm="true"
                       href="#"
                       hx-vals='{"action": "copy", "id": {{ learningscenario.id }}}'>
                      Copy</a>
                  </li>
                  <li>
                    <a
                      class="dropdown-item text-danger"
                      hx-post="."
                      hx-target="#learningscenario-{{ learningscenario.id }}"
                      hx-swap="outerHTML"
                      hx-confirm="Are you sure you want to delete this item?"
                      hx-vals='{"action": "delete", "id": {{ learningscenario.id }}}'
                      href="#">
                      Delete
                    </a>
                  </li>
                </ul>
              </div>
            </h5>
            <div class="card-text">
              <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">

                <!-- Button Group for Practice Button and Dropdown -->
                <div class="btn-group btn-group-sm me-2" role="group" aria-label="Practice and Options">
                  <!-- Main Practice Button -->
                  <a
                    class="btn btn-primary btn-sm"
                    href='{% url "practice" learningscenario_id=learningscenario.id %}'
                    aria-label="Play the selected item"
                  >
                    <i class="fas fa-play"></i> Practice
                  </a>

                  <!-- Dropdown Button -->
                  <button
                    type="button"
                    class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    aria-label="More practice options"
                  >
                    <span class="visually-hidden">Toggle Dropdown</span>
                  </button>

                  <!-- Dropdown Menu -->
                  <ul class="dropdown-menu">
                    <li>
                      <a
                        class="dropdown-item"
                        href="{% url 'practice-sound' learningscenario_id=learningscenario.id %}"
                      >
                        <i class="fas fa-microphone"></i> Mic-based practice
                      </a>
                    </li>
                  </ul>
                </div>

                <!-- See Progress Button -->
                <div class="btn-group btn-group-sm" role="group" aria-label="See Progress">
                  <a
                    class="btn btn-secondary btn-sm"
                    href="{% url 'see-progress' learningscenario_id=learningscenario.id %}"
                    aria-label="See progress for the selected item">
                    <i class="fas fa-chart-line"></i> See Progress
                  </a>
                </div>

              </div>
            </div>
            <div class="card-footer text-muted small mt-3">
              <div>
                Clef: {{ learningscenario.clef }}
                {% if learningscenario.transpose_key != "BL" %}
                  , transposing from {{ learningscenario.transpose_key }}
                {% endif %}
              </div>
              <div>
                Level: {{ learningscenario.level }}
              </div>
              Last practiced: <span class="badge rounded-pill bg-secondary">{{ learningscenario.last_practiced }}</span>
              <br>
              Days-old: <span class="badge rounded-pill bg-secondary">{{ learningscenario.days_old }}</span>

              <!-- GitHub-style contribution grid -->
              <div class="mt-3">
                <p class="mb-1">
                  Practice History:
                  <span class="badge rounded-pill bg-success">{{ learningscenario.streak_count }} day streak</span>
                </p>
                <div class="d-flex flex-wrap" style="gap: 3px;">
                  {% with items=learningscenario.practice_history.items %}
                    {% for date, practiced in items %}
                      <div
                        class="contribution-square"
                        style="
                          width: 12px;
                          height: 12px;
                          background-color: {% if practiced %}#2cba00{% else %}#ebedf0{% endif %};
                          border-radius: 2px;"
                        title="{{ date }}: {% if practiced %}Practiced{% else %}No practice{% endif %}"
                      ></div>
                    {% endfor %}
                  {% endwith %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  <div class="text-center m-5 g-3">
    <div class="">
      <a href="{% url 'new-learning-scenario' %}?" class="btn btn-primary btn-lg m-1">
        <i class="fas fa-plus"></i> New learning scenario
      </a>
      <div id="reminder-settings-container">
        <!-- Daily reminders button - visible by default -->
        <button id="daily-reminders-btn" class="btn btn-success btn-sm mt-3">
          <i class="fas fa-bell"></i> Set up daily reminders
        </button>

        <!-- Reminder settings button - hidden by default -->
        <button id="reminder-settings-btn" style="display: none;" class="btn btn-success btn-lg mt-3" hx-get="{% url 'reminder-settings-form' %}" hx-target="#reminder-settings-container" hx-swap="innerHTML" hx-no-confirm='true'>
          <i class="fas fa-bell"></i> Reminder settings
        </button>

        <!-- Push notifications button - hidden by default -->
        <button id="enable-notifications-btn" style="display: none;" class="btn btn-info btn-sm mt-3 ms-2">
          <i class="fas fa-bell"></i> Enable Push Notifications
        </button>

        <!-- Notification status indicator -->
        <div id="notification-status" class="mt-2" style="display: none;">
          <span class="badge bg-success">Push notifications enabled</span>
        </div>
      </div>
    </div>
  </div>

  <!-- PWA Installation Script -->
  <script>
    let deferredPrompt;
    let swRegistration = null;
    let pushNotificationsInitialized = false;

    document.addEventListener("DOMContentLoaded", function() {
      const dailyRemindersBtn = document.getElementById('daily-reminders-btn');
      const reminderSettingsBtn = document.getElementById('reminder-settings-btn');
      const enableNotificationsBtn = document.getElementById('enable-notifications-btn');
      const notificationStatus = document.getElementById('notification-status');

      // Debug info for PWA installation
      console.log("PWA Debug Info:");
      console.log("- Is in standalone mode:", window.matchMedia('(display-mode: standalone)').matches);
      console.log("- Is in iOS:", /iPad|iPhone|iPod/.test(navigator.userAgent));
      const isHttps = window.location.protocol === 'https:';
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      console.log("- Is HTTPS:", isHttps, isLocalhost ? "HOWEVER this is OK as on localhost" : "");
      console.log("- Has service worker:", 'serviceWorker' in navigator);
      console.log("- Has push manager:", 'PushManager' in window);

      // Check if the app is already installed
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log("App is already installed and running in standalone mode");
        // App is already installed, show reminder settings button and hide daily reminders button
        if (dailyRemindersBtn && reminderSettingsBtn) {
          dailyRemindersBtn.style.display = 'none';
          reminderSettingsBtn.style.display = 'inline-block';
        }

        // Even if the app is installed, we still need to check for push notification permission
        // This ensures users can set up notifications even if they've already installed the PWA
        initializePushNotifications();
      } else {
        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
          console.log("beforeinstallprompt event fired - PWA is installable");
          // Save the event for later
          deferredPrompt = e;

          // Enable the button
          if (dailyRemindersBtn) {
            dailyRemindersBtn.disabled = false;
          }
        });

        // Log if the beforeinstallprompt event doesn't fire after a reasonable time
        setTimeout(() => {
          if (!deferredPrompt) {
            console.log("beforeinstallprompt event did not fire after 3 seconds. Possible reasons:");
            console.log("- PWA criteria not met (manifest, service worker, https, etc.)");
            console.log("- User has already installed the app");
            console.log("- Browser doesn't support PWA installation");

            // Additional debug info to help diagnose installation issues
            console.log("Additional PWA Debug Info:");
            console.log("- Browser:", navigator.userAgent);
            console.log("- Display mode:", window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser');
            console.log("- Service worker status:", 'serviceWorker' in navigator ? 'supported' : 'not supported');

            // Check if the app is already installed in a different way
            if (window.matchMedia('(display-mode: standalone)').matches ||
                (navigator.standalone === true) ||
                document.referrer.includes('android-app://')) {
              console.log("App appears to be already installed based on display mode or referrer");
            }

            // Even if we can't install the PWA, we should still check for push notification permission
            // This ensures users can set up notifications even if PWA installation isn't available
            initializePushNotifications();
          }
        }, 3000);
      }

      // Add click event to the daily reminders button
      if (dailyRemindersBtn) {
        dailyRemindersBtn.addEventListener('click', async () => {
          // First check if push notifications are supported
          const pushSupported = 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window;

          // Function to handle push notification permission
          const handlePushPermission = () => {
            if (pushSupported) {
              // Request notification permission
              Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                  console.log('Notification permission granted');
                  // Subscribe to push notifications
                  if (swRegistration) {
                    subscribeToPushNotifications();
                  } else {
                    // If service worker registration isn't ready yet, wait for it
                    navigator.serviceWorker.ready.then(registration => {
                      swRegistration = registration;
                      subscribeToPushNotifications();
                    });
                  }
                } else {
                  console.log('Notification permission denied');
                  Swal.fire({
                    title: 'Notifications Blocked',
                    text: 'You have blocked notifications. To enable them, please update your browser settings.',
                    icon: 'info',
                    confirmButtonColor: '#28a745'
                  });
                }
              });
            }

            // Show reminder settings button and hide daily reminders button
            if (dailyRemindersBtn && reminderSettingsBtn) {
              dailyRemindersBtn.style.display = 'none';
              reminderSettingsBtn.style.display = 'inline-block';
              reminderSettingsBtn.click(); // Automatically open reminder settings
            }
          };

          // Check if we need to install PWA
          if (deferredPrompt) {
            // Show SweetAlert with installation and notification instructions
            Swal.fire({
              title: 'Set Up Daily Reminders',
              html: `
                <div class="text-start">
                  <p>To receive daily practice reminders, you need to:</p>
                  <ol>
                    <li>Install Tootology as an app on your device</li>
                    <li>Allow push notifications</li>
                  </ol>
                  <p>Click "Continue" to proceed with both steps.</p>
                </div>
              `,
              icon: 'info',
              showCancelButton: true,
              confirmButtonText: 'Continue',
              cancelButtonText: 'Cancel',
              confirmButtonColor: '#28a745',
              cancelButtonColor: '#6c757d',
            }).then((result) => {
              if (result.isConfirmed) {
                // Show the install prompt
                deferredPrompt.prompt();

                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                  if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    // After installation, handle push notification permission
                    setTimeout(handlePushPermission, 1000); // Small delay to ensure installation completes
                  } else {
                    console.log('User dismissed the install prompt');
                    // Even if they don't install, still offer push notifications
                    handlePushPermission();
                  }
                  // Clear the saved prompt
                  deferredPrompt = null;
                });
              }
            });
          } else if (window.matchMedia('(display-mode: standalone)').matches) {
            // App is already installed, just handle push notifications
            handlePushPermission();
          } else {
            // If deferredPrompt is not available, show instructions for manual installation
            // First, check if we're on a browser that supports PWA installation
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            // Brave detection is tricky as it doesn't always expose the brave property
            const isBrave = /Chrome/.test(navigator.userAgent) &&
                           (/Brave/.test(navigator.userAgent) ||
                            (typeof window.navigator.brave !== 'undefined'));

            // Log browser detection for debugging
            console.log("Browser detection:", { isChrome, isEdge, isSafari, isFirefox, isBrave });

            let installInstructions = '';

            if (isChrome || isEdge || isBrave) {
              installInstructions = `
                <ul>
                  <li>Click the menu button in your browser (⋮)</li>
                  <li>Select "Install Tootology" or "Install app"</li>
                  <li>Follow the on-screen instructions</li>
                </ul>
              `;
            } else if (isSafari) {
              installInstructions = `
                <ul>
                  <li>Tap the share button (rectangle with arrow)</li>
                  <li>Scroll down and select "Add to Home Screen"</li>
                  <li>Tap "Add" in the top-right corner</li>
                </ul>
              `;
            } else if (isFirefox) {
              installInstructions = `
                <ul>
                  <li>Click the menu button (≡)</li>
                  <li>Select "Install app" or "+ Add to Home screen"</li>
                  <li>Follow the on-screen instructions</li>
                </ul>
              `;
            } else {
              installInstructions = `
                <ul>
                  <li>Click the menu button in your browser (⋮ or ⋯)</li>
                  <li>Select "Install Tootology" or "Add to Home Screen"</li>
                  <li>Follow the on-screen instructions</li>
                </ul>
              `;
            }

            Swal.fire({
              title: 'Set Up Daily Reminders',
              html: `
                <div class="text-start">
                  <p>To receive daily practice reminders, you need to:</p>
                  <ol>
                    <li>Install Tootology as an app:
                      ${installInstructions}
                    </li>
                    <li>Allow push notifications when prompted</li>
                  </ol>
                  <p><strong>Note:</strong> If you don't see the install option, your browser might not support PWA installation or the app might already be installed.</p>
                </div>
              `,
              icon: 'info',
              confirmButtonText: 'Continue',
              confirmButtonColor: '#28a745',
            }).then((result) => {
              if (result.isConfirmed) {
                // Handle push notification permission
                handlePushPermission();
              }
            });
          }
        });
      }

      // Listen for the appinstalled event
      window.addEventListener('appinstalled', (e) => {
        console.log('App was installed');

        // Show success message
        Swal.fire({
          title: 'Installation Successful!',
          text: 'Tootology has been installed. You can now receive daily practice reminders!',
          icon: 'success',
          confirmButtonColor: '#28a745',
        }).then(() => {
          // Show reminder settings button and hide daily reminders button
          if (dailyRemindersBtn && reminderSettingsBtn) {
            dailyRemindersBtn.style.display = 'none';
            reminderSettingsBtn.style.display = 'inline-block';
          }

          // After installation, check if we can enable push notifications
          initializePushNotifications();
        });
      });

      // Initialize push notifications - this will check if the browser supports push notifications
      // and show the appropriate UI elements
      initializePushNotifications();

      // Function to initialize push notifications
      // This function checks if the browser supports push notifications,
      // gets the service worker registration, and checks the notification permission.
      // Based on these checks, it shows or hides the appropriate UI elements.
      function initializePushNotifications() {
        console.log('Initializing push notifications...');

        // Check if push notifications have already been initialized
        if (pushNotificationsInitialized) {
          console.log('Push notifications already initialized, skipping');
          return;
        }

        // Set the flag to true to prevent multiple initializations
        pushNotificationsInitialized = true;

        // Always show the button on Mac to ensure it's visible
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        if (isMac) {
          console.log('Mac detected, ensuring notification button is visible');
          if (enableNotificationsBtn) {
            enableNotificationsBtn.style.display = 'inline-block';
            // Remove any existing event listeners to prevent duplicates
            enableNotificationsBtn.removeEventListener('click', requestNotificationPermission);
            // Add the event listener
            enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
          }
        }

        // Check if service worker, push manager, and notifications are supported
        if (!('serviceWorker' in navigator) || !('PushManager' in window) || !('Notification' in window)) {
          console.log('Push notifications not supported in this browser');
          // Even if push notifications aren't supported, we should still show the reminder settings
          // button if the app is installed, so users can set up reminder times
          if (window.matchMedia('(display-mode: standalone)').matches && reminderSettingsBtn) {
            console.log('App is in standalone mode, showing reminder settings button');
            reminderSettingsBtn.style.display = 'inline-block';
            if (dailyRemindersBtn) {
              dailyRemindersBtn.style.display = 'none';
            }
          }
          return;
        }

        // Get the service worker registration
        navigator.serviceWorker.ready
          .then(registration => {
            console.log('Service Worker is ready');
            console.log('Service Worker scope:', registration.scope);

            // Check if the service worker scope is appropriate for push notifications
            // Push notifications typically need a scope at the root level
            const scope = registration.scope;
            if (!scope.endsWith('/') && !scope.endsWith('/static/js/') && !scope.endsWith('/static/')) {
              console.warn('Service Worker scope may not be appropriate for push notifications:', scope);
              console.warn('Push notifications typically work best with a root-level scope (/)');
            }

            swRegistration = registration;

            // Check notification permission
            const notificationPermission = Notification.permission;
            console.log('Current notification permission:', notificationPermission);

            if (notificationPermission === 'granted') {
              console.log('Notification permission already granted');
              // Check if already subscribed
              checkSubscription();

              // If the app is installed and notification permission is granted,
              // show the reminder settings button and hide the daily reminders button
              if (window.matchMedia('(display-mode: standalone)').matches) {
                if (reminderSettingsBtn) {
                  reminderSettingsBtn.style.display = 'inline-block';
                }
                if (dailyRemindersBtn) {
                  dailyRemindersBtn.style.display = 'none';
                }
              }
            } else if (notificationPermission === 'denied') {
              console.log('Notification permission denied');
              // Even if notification permission is denied, we should still show the reminder settings
              // button if the app is installed, so users can set up reminder times
              if (window.matchMedia('(display-mode: standalone)').matches && reminderSettingsBtn) {
                console.log('App is in standalone mode, showing reminder settings button');
                reminderSettingsBtn.style.display = 'inline-block';
                if (dailyRemindersBtn) {
                  dailyRemindersBtn.style.display = 'none';
                }
              }
            } else {
              // Show the enable notifications button
              console.log('Notification permission is default, showing button');
              if (enableNotificationsBtn) {
                enableNotificationsBtn.style.display = 'inline-block';
                // Remove any existing event listeners to prevent duplicates
                enableNotificationsBtn.removeEventListener('click', requestNotificationPermission);
                // Add the event listener
                enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
              }
            }
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
            // Show the button anyway if service worker registration fails
            if (enableNotificationsBtn) {
              console.log('Showing notification button despite service worker error');
              enableNotificationsBtn.style.display = 'inline-block';
              // Remove any existing event listeners to prevent duplicates
              enableNotificationsBtn.removeEventListener('click', requestNotificationPermission);
              // Add the event listener
              enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
            }

            // Even if service worker registration fails, we should still show the reminder settings
            // button if the app is installed, so users can set up reminder times
            if (window.matchMedia('(display-mode: standalone)').matches && reminderSettingsBtn) {
              console.log('App is in standalone mode, showing reminder settings button');
              reminderSettingsBtn.style.display = 'inline-block';
              if (dailyRemindersBtn) {
                dailyRemindersBtn.style.display = 'none';
              }
            }
          });
      }

      // Function to request notification permission from the user
      // This function is called when the user clicks the "Enable Push Notifications" button
      // It requests permission to show notifications and, if granted, subscribes the user to push notifications
      function requestNotificationPermission() {
        // Use the same handlePushPermission function that's used by the "Set up daily reminders" button
        // This ensures consistent behavior between the two buttons
        const handlePushPermission = () => {
          const pushSupported = 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window;

          if (pushSupported) {
            Notification.requestPermission()
              .then(permission => {
                if (permission === 'granted') {
                  console.log('Notification permission granted');
                  // Subscribe to push notifications
                  if (swRegistration) {
                    subscribeToPushNotifications();
                  } else {
                    // If service worker registration isn't ready yet, wait for it
                    navigator.serviceWorker.ready.then(registration => {
                      swRegistration = registration;
                      subscribeToPushNotifications();
                    });
                  }
                } else {
                  console.log('Notification permission denied');
                  // Show a message to the user explaining how to enable notifications if they were denied
                  Swal.fire({
                    title: 'Notifications Blocked',
                    text: 'You have blocked notifications. To enable them, please update your browser settings.',
                    icon: 'info',
                    confirmButtonColor: '#28a745'
                  });
                }
              });
          }

          // Show reminder settings button if it exists
          if (reminderSettingsBtn) {
            reminderSettingsBtn.style.display = 'inline-block';
            // Only hide the daily reminders button if it exists and is visible
            if (dailyRemindersBtn && dailyRemindersBtn.style.display !== 'none') {
              dailyRemindersBtn.style.display = 'none';
            }
            // Automatically open reminder settings
            reminderSettingsBtn.click();
          }
        };

        handlePushPermission();
      }

      // Function to check existing subscription
      function checkSubscription() {
        // Check if we're on a Mac - if so, we want to ensure the button is visible
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;

        if (!swRegistration) {
          console.log('No service worker registration available');
          // On Mac, show the button even without service worker registration
          if (isMac && enableNotificationsBtn) {
            console.log('Mac detected, showing notification button despite missing registration');
            enableNotificationsBtn.style.display = 'inline-block';
            enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
          }
          return;
        }

        swRegistration.pushManager.getSubscription()
          .then(subscription => {
            if (subscription) {
              console.log('User is already subscribed to push notifications');
              updateSubscriptionOnServer(subscription);
              // On Mac, we might still want to show the button even if subscribed
              if (isMac) {
                console.log('Mac detected, showing notification button despite existing subscription');
                if (enableNotificationsBtn) {
                  enableNotificationsBtn.style.display = 'inline-block';
                  enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
                }
              } else {
                updatePushNotificationUI(true);
              }
            } else {
              console.log('User is not subscribed to push notifications');
              // Show the enable notifications button
              if (enableNotificationsBtn) {
                enableNotificationsBtn.style.display = 'inline-block';
                enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
              }
            }
          })
          .catch(error => {
            console.error('Error checking subscription:', error);
            // On Mac, show the button even if there's an error checking subscription
            if (isMac && enableNotificationsBtn) {
              console.log('Mac detected, showing notification button despite subscription error');
              enableNotificationsBtn.style.display = 'inline-block';
              enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
            }
          });
      }

      // Function to subscribe to push notifications
      // This function is called after the user grants notification permission
      // It subscribes the user to push notifications using the Web Push API
      // and sends the subscription information to the server
      function subscribeToPushNotifications() {
        console.log('Attempting to subscribe to push notifications...');

        // Check if user is authenticated
        const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
        console.log('User authentication status:', isAuthenticated ? 'Authenticated' : 'Not authenticated');

        if (!isAuthenticated) {
          console.error('User is not authenticated. Push notification subscription requires authentication.');
          // Show a message to the user
          Swal.fire({
            title: 'Authentication Required',
            text: 'You need to be logged in to receive push notifications. Please log in and try again.',
            icon: 'warning',
            confirmButtonColor: '#28a745'
          });
          return;
        }

        if (!swRegistration) {
          console.error('No service worker registration available for push subscription');

          // Try to get the service worker registration again
          console.log('Attempting to get service worker registration again...');
          navigator.serviceWorker.ready
            .then(registration => {
              console.log('Service Worker registration obtained:', registration);
              console.log('Service Worker scope:', registration.scope);
              swRegistration = registration;

              // Now try to subscribe again
              console.log('Retrying subscription with new registration...');
              subscribeToPushNotifications();
            })
            .catch(error => {
              console.error('Failed to get service worker registration:', error);
            });
          return;
        }

        // Log the service worker registration details
        console.log('Using service worker registration:', swRegistration);
        console.log('Service worker scope:', swRegistration.scope);

        // Check notification permission
        const notificationPermission = Notification.permission;
        console.log('Current notification permission:', notificationPermission);

        if (notificationPermission !== 'granted') {
          console.error('Notification permission is not granted:', notificationPermission);

          if (notificationPermission === 'denied') {
            // Show a message to the user
            Swal.fire({
              title: 'Notifications Blocked',
              text: 'You have blocked notifications. To enable them, please update your browser settings.',
              icon: 'warning',
              confirmButtonColor: '#28a745'
            });
          } else {
            // Request permission
            console.log('Requesting notification permission...');
            Notification.requestPermission().then(permission => {
              console.log('Notification permission response:', permission);
              if (permission === 'granted') {
                console.log('Notification permission granted, proceeding with subscription');
                // Continue with subscription after permission is granted
                subscribeToPushNotifications();
              } else {
                console.error('Notification permission denied or dismissed');
                // Show a message to the user
                Swal.fire({
                  title: 'Notifications Not Enabled',
                  text: 'You need to allow notifications to receive practice reminders.',
                  icon: 'warning',
                  confirmButtonColor: '#28a745'
                });
              }
            });
          }

          return;
        }

        // Check the service worker activation state
        if (swRegistration.active) {
          console.log('Service worker is active');
        } else if (swRegistration.installing) {
          console.log('Service worker is installing');

          // Wait for the service worker to be activated
          swRegistration.installing.addEventListener('statechange', event => {
            if (event.target.state === 'activated') {
              console.log('Service worker is now activated, proceeding with subscription');
              // Continue with subscription after activation
              subscribeToPushNotifications();
              return;
            } else {
              console.log('Service worker state changed to:', event.target.state);
            }
          });

          console.log('Waiting for service worker to be activated before subscribing');
          return;
        } else if (swRegistration.waiting) {
          console.log('Service worker is waiting');

          // Show a message to the user
          Swal.fire({
            title: 'Update Required',
            text: 'A new version of the app is available. Please reload the page to update.',
            icon: 'info',
            confirmButtonColor: '#28a745',
            confirmButtonText: 'Reload'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.reload();
            }
          });

          return;
        } else {
          console.error('Service worker is in an unknown state');
          return;
        }

        // Application server public key from Django settings
        const applicationServerPublicKey = '{{ vapid_public_key|escapejs }}';
        console.log('Using VAPID public key:', applicationServerPublicKey);

        // Check if the VAPID public key is valid
        if (!applicationServerPublicKey || applicationServerPublicKey === 'None') {
          console.error('Invalid VAPID public key:', applicationServerPublicKey);
          console.error('Push notifications will not work without a valid VAPID public key.');

          // Show error message to user
          Swal.fire({
            title: 'Push Notification Setup Error',
            text: 'There was a problem with the push notification configuration. Please contact the administrator.',
            icon: 'error',
            confirmButtonColor: '#28a745'
          });
          return;
        }

        // Convert the public key to a Uint8Array
        function urlB64ToUint8Array(base64String) {
          try {
            console.log('Converting base64 string to Uint8Array:', base64String);
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
              .replace(/\-/g, '+')
              .replace(/_/g, '/');

            console.log('Padded and transformed base64 string:', base64);

            try {
              const rawData = window.atob(base64);
              console.log('Successfully decoded base64 string, length:', rawData.length);

              const outputArray = new Uint8Array(rawData.length);

              for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
              }

              console.log('Successfully created Uint8Array, length:', outputArray.length);
              return outputArray;
            } catch (error) {
              console.error('Error decoding base64 string:', error);
              throw new Error('Invalid base64 string: ' + error.message);
            }
          } catch (error) {
            console.error('Error converting VAPID key to Uint8Array:', error);

            // Show error message to user
            Swal.fire({
              title: 'Push Notification Setup Error',
              text: 'There was a problem with the push notification configuration. Please contact the administrator.',
              icon: 'error',
              confirmButtonColor: '#28a745'
            });

            throw error;
          }
        }

        let convertedApplicationServerPublicKey;
        try {
          convertedApplicationServerPublicKey = urlB64ToUint8Array(applicationServerPublicKey);
          console.log('Successfully converted public key for subscription');
        } catch (error) {
          console.error('Failed to convert public key:', error);
          return;
        }

        // Check if already subscribed before subscribing
        swRegistration.pushManager.getSubscription()
          .then(existingSubscription => {
            if (existingSubscription) {
              console.log('User already has an existing push subscription:', existingSubscription);
              updateSubscriptionOnServer(existingSubscription);
              updatePushNotificationUI(true);
              return;
            }

            console.log('No existing subscription found, creating new subscription...');
            // Subscribe the user
            console.log('Calling pushManager.subscribe with applicationServerKey...');
            swRegistration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: convertedApplicationServerPublicKey
            })
            .then(subscription => {
              console.log('Successfully subscribed to push notifications');

              // Log subscription details
              console.log('Subscription object:', subscription);
              console.log('Subscription JSON:', JSON.stringify(subscription));
              console.log('Subscription endpoint:', subscription.endpoint);

              // Check if the subscription has the required fields
              if (!subscription.endpoint) {
                console.error('Subscription missing endpoint');
              }

              if (!subscription.keys || !subscription.keys.p256dh || !subscription.keys.auth) {
                console.error('Subscription missing required keys');
                console.log('Keys object:', subscription.keys);
              } else {
                console.log('Subscription has required keys');
              }

              // Update the server and UI
              updateSubscriptionOnServer(subscription);
              updatePushNotificationUI(true);

              // Show success message to user
              Swal.fire({
                title: 'Push Notifications Enabled',
                text: 'You will now receive practice reminders!',
                icon: 'success',
                confirmButtonColor: '#28a745'
              });
            })
            .catch(error => {
              console.error('Failed to subscribe to push notifications:', error);
              console.error('Error details:', error.message, error.name);

              // Provide more specific error messages based on the error
              if (error.name === 'NotAllowedError') {
                console.error('Permission denied for push notifications');
                Swal.fire({
                  title: 'Permission Denied',
                  text: 'You have denied permission for push notifications. Please update your browser settings to allow notifications.',
                  icon: 'warning',
                  confirmButtonColor: '#28a745'
                });
              } else if (error.name === 'InvalidStateError') {
                console.error('Service worker not activated or permission not granted');
                Swal.fire({
                  title: 'Setup Error',
                  text: 'There was a problem with the push notification setup. Please try again later.',
                  icon: 'error',
                  confirmButtonColor: '#28a745'
                });
              } else if (error.name === 'AbortError') {
                console.error('Push service error - subscription aborted');

                // Try to get more detailed information about the error
                let errorDetails = 'Unknown error';
                if (error.message) {
                  errorDetails = error.message;
                  console.error('AbortError message:', error.message);
                }

                // Check if this is a push service error
                if (errorDetails.includes('push service error')) {
                  console.error('This appears to be a push service error');

                  // Retry the subscription with a delay
                  console.log('Retrying subscription in 2 seconds...');
                  setTimeout(() => {
                    console.log('Retrying subscription now');
                    swRegistration.pushManager.subscribe({
                      userVisibleOnly: true,
                      applicationServerKey: convertedApplicationServerPublicKey
                    })
                    .then(subscription => {
                      console.log('Retry successful - subscribed to push notifications');
                      updateSubscriptionOnServer(subscription);
                      updatePushNotificationUI(true);

                      // Show success message to user
                      Swal.fire({
                        title: 'Push Notifications Enabled',
                        text: 'You will now receive practice reminders!',
                        icon: 'success',
                        confirmButtonColor: '#28a745'
                      });
                    })
                    .catch(retryError => {
                      console.error('Retry failed:', retryError);
                      Swal.fire({
                        title: 'Push Notification Error',
                        text: 'There was a problem with the push service. Please try again later.',
                        icon: 'error',
                        confirmButtonColor: '#28a745'
                      });
                    });
                  }, 2000);
                } else {
                  // Show a generic error message
                  Swal.fire({
                    title: 'Push Notification Error',
                    text: 'There was a problem with the push service: ' + errorDetails,
                    icon: 'error',
                    confirmButtonColor: '#28a745'
                  });
                }
              } else {
                Swal.fire({
                  title: 'Push Notification Error',
                  text: 'There was a problem enabling push notifications: ' + error.message,
                  icon: 'error',
                  confirmButtonColor: '#28a745'
                });
              }

              updatePushNotificationUI(false);
            });
          })
          .catch(error => {
            console.error('Error checking existing subscription:', error);
          });
      }

      // Function to update subscription on server
      // This function sends the push subscription information to the server
      // so it can be stored in the database and used to send push notifications to the user
      function updateSubscriptionOnServer(subscription) {
        // Check if subscription is valid
        if (!subscription) {
          console.error('Invalid subscription object: null or undefined');
          return;
        }

        // Validate subscription object has required properties
        if (!subscription.endpoint) {
          console.error('Invalid subscription object: missing endpoint');
          return;
        }

        try {
          // Try to access keys to see if they exist
          const keys = subscription.keys;
          if (!keys || !keys.p256dh || !keys.auth) {
            console.error('Invalid subscription object: missing required keys');
            console.log('Keys object:', keys);
            return;
          }
        } catch (error) {
          console.error('Error accessing subscription keys:', error);
          return;
        }

        // Check if user is authenticated
        const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
        console.log('User authentication status:', isAuthenticated ? 'Authenticated' : 'Not authenticated');

        if (!isAuthenticated) {
          console.error('User is not authenticated. Push notification subscription requires authentication.');
          // Show a message to the user
          Swal.fire({
            title: 'Authentication Required',
            text: 'You need to be logged in to receive push notifications. Please log in and try again.',
            icon: 'warning',
            confirmButtonColor: '#28a745'
          });
          return;
        }

        // Convert the subscription to a JSON string
        const subscriptionJson = JSON.stringify(subscription);
        console.log('Preparing to send subscription to server:', subscriptionJson);

        // Log the endpoint URL and CSRF token (partially masked for security)
        const csrfToken = '{{ csrf_token }}';
        console.log('Endpoint URL:', '/api/save-subscription/');
        console.log('CSRF Token:', csrfToken.substring(0, 4) + '...' + csrfToken.substring(csrfToken.length - 4));

        // Send the subscription to your server
        fetch('/api/save-subscription/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: subscriptionJson
        })
        .then(response => {
          console.log('Server response status:', response.status);

          // Log the full response for debugging
          console.log('Server response:', response);

          // Check if response is ok (status in the range 200-299)
          if (!response.ok) {
            console.error('Server returned error status:', response.status);
            console.error('Response status text:', response.statusText);

            // Try to get more details from the response
            return response.text().then(text => {
              try {
                // Try to parse as JSON
                const errorData = JSON.parse(text);
                console.error('Error response data:', errorData);
                throw new Error(`Failed to save subscription on server: ${response.status} ${response.statusText} - ${errorData.message || 'Unknown error'}`);
              } catch (e) {
                // If not JSON, use the text
                console.error('Error response text:', text);
                throw new Error(`Failed to save subscription on server: ${response.status} ${response.statusText} - ${text || 'Unknown error'}`);
              }
            });
          }

          // If response is ok, try to parse as JSON
          return response.json().catch(error => {
            console.error('Error parsing response as JSON:', error);
            return { status: 'success', message: 'Subscription saved (response not JSON)' };
          });
        })
        .then(data => {
          console.log('Subscription saved on server successfully:', data);

          // Check if the response indicates success
          if (data.status === 'success') {
            console.log('Server confirmed subscription was saved successfully');

            // Show success message in UI
            if (notificationStatus) {
              notificationStatus.style.display = 'block';
            }

            // Show success message to user
            Swal.fire({
              title: 'Push Notifications Enabled',
              text: 'You will now receive practice reminders!',
              icon: 'success',
              confirmButtonColor: '#28a745'
            });
          } else {
            console.warn('Server response does not explicitly indicate success:', data);
          }
        })
        .catch(error => {
          console.error('Error saving subscription:', error);
          console.error('Error details:', error.message);
          // Show error message to user
          Swal.fire({
            title: 'Notification Setup Failed',
            text: 'There was a problem setting up push notifications. Please try again later.',
            icon: 'error',
            confirmButtonColor: '#28a745'
          });
        });
      }

      // Function to update the UI based on subscription status
      // This function shows or hides UI elements based on whether the user is subscribed to push notifications
      // If subscribed, it hides the "Enable Push Notifications" button and shows the "Push notifications enabled" status
      // If not subscribed, it shows the "Enable Push Notifications" button and hides the status
      function updatePushNotificationUI(subscribed) {
        // Check if we're on a Mac - if so, we want to ensure the button is visible
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;

        if (subscribed) {
          if (isMac) {
            console.log('Mac detected, keeping notification button visible despite subscription');
            // On Mac, always show the button
            if (enableNotificationsBtn) {
              enableNotificationsBtn.style.display = 'inline-block';
            }

            // Also show the notification status
            if (notificationStatus) {
              notificationStatus.style.display = 'block';
            }
          } else {
            // Hide the enable notifications button on non-Mac platforms
            if (enableNotificationsBtn) {
              enableNotificationsBtn.style.display = 'none';
            }

            // Show the notification status
            if (notificationStatus) {
              notificationStatus.style.display = 'block';
            }
          }
        } else {
          // Show the enable notifications button
          if (enableNotificationsBtn) {
            enableNotificationsBtn.style.display = 'inline-block';
          }

          // Hide the notification status
          if (notificationStatus) {
            notificationStatus.style.display = 'none';
          }
        }
      }
    });
  </script>
{% endblock content %}
