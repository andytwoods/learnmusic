{% extends 'notes/practice.html' %}
{% load static %}

{% block css %}
  {{ block.super }}
{% endblock css %}

{% block bodyclass %}
  bg-light
{% endblock %}

{% block saveResult %}

  <script>
    (function cache_key() {
      const instrument = '{{ instrument }}';
      const level = '{{ level }}';
      const clef = '{{ clef }}';
      const shifted_octave = '{{ octave }}';
      const key = '{{ key }}';
      let absolute_pitch = '{{ absolute_pitch }}';
      let signatures = '{{ selected_signatures }}';



      window.cache_key = [instrument, level, clef, shifted_octave, key, absolute_pitch, signatures].join('_')
    }());

    function saveResult(note, reactionTime, correct) {
      cache.save(window.cache_key, window.progress_data);
    }
  </script>

{% endblock saveResult %}

{% block load_progress_data_from_cache %}
  <script>
    (function () {
      let progress_data_exists = cache.get(window.cache_key, []) || [];
      if (progress_data_exists.length > 0) {
        window.progress_data = progress_data_exists;
        console.log('Progress data loaded from cache');
      }
    }());

  </script>


{% endblock load_progress_data_from_cache %}

{% block cardbody %}

  {{ instrument_defaults|json_script:"instrument_defaults" }}
  <script>
    window.instrument_defaults = JSON.parse(
      document.getElementById('instrument_defaults').textContent
    )
  </script>

  <div id="right-menu-local-options" style="display: none;">
    <li><h6 class="dropdown-header">App related</h6></li>

    <li>
      <a class="mx-2 btn btn-light btn-sm " href="#" id="move-data-to-cloud-btn">
        <i class="fa-solid fa-cloud-arrow-up me-2 "></i> Move data to the cloud
      </a>
    </li>
    <li id="install-prompt-container" style="display: none;">
      <a class="m-2 btn btn-light btn-sm " href="#" id="install-pwa-btn">
        <i class="fa-solid fa-download me-2"></i> Install App
      </a>
    </li>
    <li id="add-homescreen-container">
      <a class="m-2 btn btn-light btn-sm " href="#" id="add-homescreen-btn">
        <i class="fa-solid fa-mobile-screen-button me-2"></i> Add this specific practice as a bespoke app to your
        device's home screen
      </a>
    </li>
    <li>
      <hr class="dropdown-divider">
    </li>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const items_container = document.getElementById("right-menu-local-options");
      const rightMenu = document.getElementById("right-menu");
      if (window.top === window.self) {
        if (items_container && rightMenu) {
          const frag = document.createDocumentFragment();
          while (items_container.firstElementChild) {
            frag.appendChild(items_container.firstElementChild);
          }
          rightMenu.appendChild(frag);
          items_container.parentNode.removeChild(items_container);
        }
      }

      // Attach SweetAlert2 info for moving data to the cloud
      const moveBtn = document.getElementById("move-data-to-cloud-btn");
      if (moveBtn) {
        moveBtn.addEventListener("click", function (e) {
          e.preventDefault();

          {% if request.user.is_authenticated %}

            function send_json_to_backend(data_bundle, url) {

              fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                  data: data_bundle,
                  source: 'cloud_upload',
                  timestamp: new Date().toISOString()
                })
              })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  return response.json();
                })
                .then(data => {
                  // Handle successful response
                  Swal.fire({
                    title: 'Success!',
                    text: 'Your data has been uploaded to the cloud',
                    icon: 'success'
                  });

                  // Optional: Clear local data or redirect
                  // window.localStorage.removeItem('your_local_data_key');
                  // window.location.href = '/success-page/';
                })
                .catch(error => {
                  console.error('Error:', error);

                  // Show error message
                  Swal.fire({
                    title: 'Upload Failed',
                    text: 'There was a problem uploading your data. Please try again.',
                    icon: 'error'
                  });
                });
            }




            Swal.fire({
              title: "Move data to the cloud",
              html: "This will create a copy in the cloud of your locally stored data. Proceed?",
              confirmButtonText: "OK"
            }).then((result) => {
              if (result.isConfirmed) {

                let data_bundle = {'notes_history': JSON.parse(JSON.stringify(window.progress_data || []))};
                data_bundle['info'] = {
                  instrument: '{{ instrument }}',
                  level: '{{ level }}',
                  clef: '{{ clef }}',
                  shifted_octave: '{{ octave }}',
                  key: '{{ key }}',
                  absolute_pitch: '{{absolute_pitch }}'
                }
                send_json_to_backend(data_bundle, '{% url 'cache-to-backend' %}');
              }
            });

          {% else %}
            Swal.fire({
              title: "Move data to the cloud",
              html: "To move your data to the cloud, please <a href={% url 'account_signup' %}>create an account</a> or <a href='{% url 'account_login' %}'>sign in</a>. " +
                "Once your account is set up, we will ask you if you want to move your cache practice data to the cloud.",
              confirmButtonText: "OK"
            });
          {% endif %}
        });
      }
    });
  </script>

  {% include 'notes/components/_pwa.html' %}

{% endblock cardbody %}

{% block timeup %}
  {% include 'notes/components/_timeup.html' %}
  </div>{% endblock timeup %}

{% block cardheader %}
  {% include 'notes/components/_practice_menu.html' %}
  {% include 'notes/components/practice_dropdown_menu_right.html' %}
{% endblock cardheader %}

{% block see_results %}
  {% include 'notes/components/_practice_see_results.html' %}
{% endblock see_results %}

{% block navbar %}{% endblock navbar %}
{% block messages %}{% endblock messages %}

