{% extends 'notes/practice.html' %}
{% load static %}

{% block css %}
  {{ block.super }}
{% endblock css %}

{% block bodyclass %}
  bg-light
{% endblock %}

{% block saveResult %}

  <script>

    function saveResult(note, reactionTime, correct) {
      cache.save(window.cache_key, window.progress_data);
    }
  </script>

{% endblock saveResult %}

{% block load_progress_data_from_cache %}
  <script>
    (function () {
      try {
        const cached = cache.get(window.cache_key);
        if (!cached) return;
        // Support legacy array shape and current object shape with notes array
        if (Array.isArray(cached)) {
          if (cached.length > 0) {
            window.progress_data = cached;
            console.log('Progress data (legacy array) loaded from cache');
          }
        } else if (typeof cached === 'object' && Array.isArray(cached.notes)) {
          window.progress_data = cached;
          console.log(`Progress data loaded from cache: ${cached.notes.length} notes`);
          // Update counter UI if present
          const counter = document.getElementById('counter-value');
          if (counter) counter.textContent = `${cached.notes.length} notes to be shown`;
        }
      } catch (e) {
        console.error('Failed to load progress data from cache', e);
      }
    }());

  </script>


{% endblock load_progress_data_from_cache %}

{% block cardbody %}

  {{ instrument_defaults|json_script:"instrument_defaults" }}
  <script>
    window.instrument_defaults = JSON.parse(
      document.getElementById('instrument_defaults').textContent
    )
    // Enable optional note identification on error for this try page
    window.enable_note_guess = true;
  </script>

  <div id="right-menu-local-options" style="display: none;">
    <li><h6 class="dropdown-header">App related</h6></li>

    <li id="install-prompt-container" style="display: none;">
      <a class="m-2 btn btn-light btn-sm " href="#" id="install-pwa-btn">
        <i class="fa-solid fa-download me-2"></i> Install App
      </a>
    </li>
    <li id="add-homescreen-container">
      <a class="m-2 btn btn-light btn-sm " href="#" id="add-homescreen-btn">
        <i class="fa-solid fa-mobile-screen-button me-2"></i> Add this specific practice as a bespoke app to your
        device's home screen
      </a>
    </li>
    <li>
      <hr class="dropdown-divider">
    </li>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const items_container = document.getElementById("right-menu-local-options");
      const rightMenu = document.getElementById("right-menu");
      if (window.top === window.self) {
        if (items_container && rightMenu) {
          const frag = document.createDocumentFragment();
          while (items_container.firstElementChild) {
            frag.appendChild(items_container.firstElementChild);
          }
          rightMenu.appendChild(frag);
          items_container.parentNode.removeChild(items_container);
        }
      }

    });
  </script>

  {% include 'notes/components/_pwa.html' %}

{% endblock cardbody %}

{% block timeup %}
  {% include 'notes/components/_timeup_try.html' %}
{% endblock timeup %}

{% block cardheader %}
  {% include 'notes/components/_practice_menu.html' %}
  {% include 'notes/components/practice_dropdown_menu_right.html' %}
{% endblock cardheader %}


{% block navbar %}{% endblock navbar %}
{% block messages %}{% endblock messages %}

