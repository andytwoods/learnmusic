{% extends 'notes/practice.html' %}
{% load static %}

{% block css %}
  {{ block.super }}
{% endblock css %}

{% block bodyclass %}
  bg-light
{% endblock %}

{% block saveResult %}

  <script>

    function saveResult(note, reactionTime, correct) {
      cache.save(window.cache_key, window.progress_data);
    }

  </script>

{% endblock saveResult %}

{% block load_progress_data_from_cache %}
  <script>
    (function () {
      try {
        const cached = cache.get(window.cache_key);

        //below only runs when we are on the homepage in an iframe. We dont want to store progress there
        if (window.self !== window.top) return;

        if (!cached) return;
        // Support legacy array shape and current object shape with notes array
        if (Array.isArray(cached)) {
          if (cached.length > 0) {
            window.progress_data = cached;
            console.log('Progress data (legacy array) loaded from cache');
          }
        } else if (typeof cached === 'object' && Array.isArray(cached.notes)) {
          window.progress_data = cached;
          console.log(`Progress data loaded from cache: ${cached.notes.length} notes`);
          // Update counter UI if present
          const counter = document.getElementById('counter-value');
          if (counter) counter.textContent = `{{ response_count }} notes to be shown`;
        }
      } catch (e) {
        console.error('Failed to load progress data from cache', e);
      }
    }());

  </script>


{% endblock load_progress_data_from_cache %}

{% block cardbody %}

  {{ instrument_defaults|json_script:"instrument_defaults" }}
  <script>
    window.instrument_defaults = JSON.parse(
      document.getElementById('instrument_defaults').textContent
    )
    // Enable optional note identification on error for this try page
    window.enable_note_guess = true;
  </script>

  <div id="right-menu-local-options" style="display: none;">
    <li><h6 class="dropdown-header">App related</h6></li>

    <li id="install-prompt-container" style="display: none;">
      <a class="m-2 btn btn-light btn-sm " href="#" id="install-pwa-btn">
        <i class="fa-solid fa-download me-2"></i> Install App
      </a>
    </li>
    <li id="add-homescreen-container">
      <a class="m-2 btn btn-light btn-sm " href="#" id="add-homescreen-btn">
        <i class="fa-solid fa-mobile-screen-button me-2"></i> Add this specific practice as a bespoke app to your
        device's home screen
      </a>
    </li>

    <!-- Reset progress button (uses htmx:confirm -> SweetAlert in project.js) -->
    <li class="px-2 py-1">
      <button
        type="button"
        class="btn btn-light btn-sm"
        onclick="resetPracticeProgress()"
      >
        <i class="fa-solid fa-rotate-left me-2"></i>Reset progress
      </button>

      <script>
        // Reset practice progress to initial state defined in progress-data JSON
        function resetPracticeProgress() {
          Swal.fire({
            title: "Are you sure?",
            text: "This will reset your progress!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, reset it!",
            cancelButtonText: "Cancel"
          }).then((result) => {
            if (result.isConfirmed) {
              const el = document.getElementById("progress-data");
              if (el) {
                window.progress_data = JSON.parse(el.textContent);
              } else {
                // Fallback: clear progress to an empty structure if progress-data is unavailable
                window.progress_data = Array.isArray(window.progress_data) ? [] : {notes: []};
              }
              // Persist the reset in cache for this practice key
              cache.save(window.cache_key, window.progress_data);

              Swal.fire({
                title: "Progress reset",
                icon: "success",
                timer: 1200,
                showConfirmButton: false
              });
            }
          });
        }
      </script>
    </li>

    <li class="px-2 py-1">
      <button
        type="button"
        class="btn btn-light btn-sm"
        onclick="resetHighscore()"
      >
        <i class="fa-solid fa-rotate-left me-2"></i>Reset highscore
      </button>

      <script>
        // Reset practice progress to initial state defined in progress-data JSON
        function resetHighscore() {
          Swal.fire({
            title: "Are you sure?",
            text: "This will reset your highscore!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, reset it!",
            cancelButtonText: "Cancel"
          }).then((result) => {
            if (result.isConfirmed) {
              feedback_manager.reset_highscore();
              Swal.fire({
                title: "Highscore reset",
                icon: "success",
                timer: 1200,
                showConfirmButton: false
              });
            }
          });
        }
      </script>
    </li>
    <li>
      <hr class="dropdown-divider">
    </li>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const items_container = document.getElementById("right-menu-local-options");
      const rightMenu = document.getElementById("right-menu");
      if (window.top === window.self) {
        if (items_container && rightMenu) {
          const frag = document.createDocumentFragment();
          while (items_container.firstElementChild) {
            frag.appendChild(items_container.firstElementChild);
          }
          rightMenu.appendChild(frag);
          items_container.parentNode.removeChild(items_container);
        }
      }

    });
  </script>

  {% include 'notes/components/_pwa.html' %}
  {% include 'notes/components/_notes_selection.html' %}


{% endblock cardbody %}

{% block timeup %}
  {% include 'notes/components/_timeup_try.html' %}
{% endblock timeup %}

{% block cardheader %}
  {% include 'notes/components/_practice_menu.html' %}
  {% include 'notes/components/practice_dropdown_menu_right.html' %}
{% endblock cardheader %}


{% block navbar %}{% endblock navbar %}
{% block messages %}{% endblock messages %}

