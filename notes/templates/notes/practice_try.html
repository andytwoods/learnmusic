{% extends 'notes/practice.html' %}
{% load static %}

{% block css %}
  {{ block.super }}
{% endblock css %}

{% block bodyclass %}
  bg-light
{% endblock %}

{% block saveResult %}

  <script>
    (function cache_key() {
      const instrument = '{{ instrument }}';
      const level = '{{ level }}';
      const clef = '{{ clef }}';
      const shifted_octave = '{{ octave }}';
      const key = '{{ key }}';
      let absolute_pitch = '{{ absolute_pitch }}';

      window.cache_key = [instrument, level, clef, shifted_octave, key, absolute_pitch].join('_')
    }());

    function saveResult(note, reactionTime, correct) {
      cache.save(window.cache_key, window.progress_data);
    }
  </script>

{% endblock saveResult %}

{% block load_progress_data_from_cache %}
  <script>
    (function () {
      let progress_data_exists = cache.get(window.cache_key, []) || [];
      if (progress_data_exists.length > 0) {
        window.progress_data = progress_data_exists;
        console.log('Progress data loaded from cache');
      }
    }());

  </script>


{% endblock load_progress_data_from_cache %}

{% block cardbody %}

  {{ instrument_defaults|json_script:"instrument_defaults" }}
  <script>
    window.instrument_defaults = JSON.parse(
      document.getElementById('instrument_defaults').textContent
    )
  </script>

  <div id="right-menu-local-options" style="display: none;">
    <li><h6 class="dropdown-header">App related</h6></li>

    <li>
      <a class="mx-2 btn btn-light btn-sm " href="#" id="move-data-to-cloud-btn">
        <i class="fa-solid fa-cloud-arrow-up me-2 "></i> Move data to the cloud
      </a>
    </li>
    <li id="install-prompt-container" style="display: none;">
      <a class="m-2 btn btn-light btn-sm " href="#" id="install-pwa-btn">
        <i class="fa-solid fa-download me-2"></i> Install App
      </a>
    </li>
    <li id="add-homescreen-container">
      <a class="m-2 btn btn-light btn-sm " href="#" id="add-homescreen-btn">
        <i class="fa-solid fa-mobile-screen-button me-2"></i> Add specifically this practice as a bespoke app to your device's home screen
      </a>
    </li>
    <li>
      <hr class="dropdown-divider">
    </li>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const items_container = document.getElementById("right-menu-local-options");
      const rightMenu = document.getElementById("right-menu");
      if (window.top === window.self) {
        if (items_container && rightMenu) {
          const frag = document.createDocumentFragment();
          while (items_container.firstElementChild) {
            frag.appendChild(items_container.firstElementChild);
          }
          rightMenu.appendChild(frag);
          items_container.parentNode.removeChild(items_container);
        }

        // Register PWA when not in iframe
        registerPWA();
      }

      let deferredPrompt;
      let isInstalled = false;

      function registerPWA() {
        // Add dynamic manifest link
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = '{% if absolute_pitch_slug %}{% url "practice-try-manifest" instrument=instrument clef=clef key=original_key_slug absolute_pitch=absolute_pitch_slug level=level octave=octave %}{% else %}{% url "practice-try-manifest" instrument=instrument clef=clef key=original_key_slug level=level octave=octave %}{% endif %}';
        document.head.appendChild(manifestLink);

        // Register service worker
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js', {scope: '/'})
            .then(function (registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(function (error) {
              console.log('ServiceWorker registration failed: ', error);
            });
        }

        // Handle PWA install prompt
        setupInstallPrompt();
      }

      function setupInstallPrompt() {
        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', function (e) {
          console.log('beforeinstallprompt event fired');
          // Prevent the mini-infobar from appearing on mobile
          e.preventDefault();
          // Stash the event so it can be triggered later
          deferredPrompt = e;
          // Show our custom install button
          showInstallButton();
        });

        // Listen for the appinstalled event
        window.addEventListener('appinstalled', function (e) {
          console.log('PWA was installed');
          isInstalled = true;
          hideInstallButton();
          showWelcomeMessage();
        });

        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
          isInstalled = true;
          hideInstallButton();
        }

        // Setup button click handlers
        setupButtonHandlers();
      }

      function showInstallButton() {
        const installContainer = document.getElementById('install-prompt-container');
        const homescreenContainer = document.getElementById('add-homescreen-container');

        if (installContainer) {
          installContainer.style.display = 'block';
        }
        if (homescreenContainer) {
          homescreenContainer.style.display = 'none';
        }
        // Also show a small inline banner to make this obvious on desktop browsers
        ensureInstallBanner();
      }

      function ensureInstallBanner() {
        // Use a per-page cache key so dismissal is remembered for this specific practice config
        const bannerCacheKey = `installBannerDismissed:${location.pathname}`;
        // Do not show if already in DOM or user previously dismissed
        if (document.getElementById('install-banner')) return;
        try {
          const dismissed = cache.get(bannerCacheKey);
          if (dismissed === true) return;
        } catch (e) {
          // If cache access fails, proceed without persistence
        }

        const banner = document.createElement('div');
        banner.id = 'install-banner';
        banner.style.position = 'fixed';
        banner.style.bottom = '16px';
        banner.style.right = '16px';
        banner.style.zIndex = '1055';
        banner.style.background = '#0d6efd';
        banner.style.color = '#fff';
        banner.style.padding = '10px 14px';
        banner.style.borderRadius = '8px';
        banner.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        banner.style.display = (window.top === window.self) ? 'flex' : 'none';
        banner.style.alignItems = 'center';
        banner.style.gap = '10px';
        banner.innerHTML = '<span><i class="fa-solid fa-download me-1"></i> Install this practice as an app on your device</span>' +
          '<button id="install-banner-btn" class="btn btn-light btn-sm">Install</button>' +
          '<button id="install-banner-close" class="btn-close btn-close-white" aria-label="Close"></button>';
        document.body.appendChild(banner);
        document.getElementById('install-banner-btn').addEventListener('click', function (e) {
          e.preventDefault();
          installPWA();
        });
        document.getElementById('install-banner-close').addEventListener('click', function () {
          try {
            cache.save(bannerCacheKey, true);
          } catch (_) {
          }
          banner.remove();
        });
      }

      function hideInstallButton() {
        const installContainer = document.getElementById('install-prompt-container');
        const homescreenContainer = document.getElementById('add-homescreen-container');
        if (installContainer) {
          installContainer.style.display = 'none';
        }
        if (homescreenContainer) {
          homescreenContainer.style.display = 'none';
        }
      }

      function setupButtonHandlers() {
        // Install button handler
        const installBtn = document.getElementById('install-pwa-btn');
        if (installBtn) {
          installBtn.addEventListener('click', function (e) {
            e.preventDefault();
            installPWA();
          });
        }

        // Add to homescreen button handler (for iOS and fallback)
        const homescreenBtn = document.getElementById('add-homescreen-btn');
        if (homescreenBtn) {
          homescreenBtn.addEventListener('click', function (e) {
            e.preventDefault();
            showHomescreenInstructions();
          });
        }
      }

      function installPWA() {
        if (!deferredPrompt) {
          console.log('No deferred prompt available');
          showHomescreenInstructions();
          return;
        }

        // Show the install prompt
        deferredPrompt.prompt();

        // Wait for the user to respond to the prompt
        deferredPrompt.userChoice.then(function (choiceResult) {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
          } else {
            console.log('User dismissed the install prompt');
          }
          deferredPrompt = null;
        });
      }

      function showWelcomeMessage() {
        // Show welcome message after installation
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'Welcome!',
            html: 'The {{ instrument|title }} Practice app has been installed successfully!<br><br>' +
              'You can now access it from your home screen even when offline.<br>' +
              'Your practice progress will be saved locally.',
            icon: 'success',
            confirmButtonText: 'Start Practicing',
            timer: 8000,
            timerProgressBar: true
          });
        }
      }

      function showHomescreenInstructions() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMac = /Mac OS X|Macintosh/.test(navigator.userAgent);
        const isBrave = /Brave/i.test(navigator.userAgent) || (navigator.brave && typeof navigator.brave.isBrave === 'function');

        let instructions = '';
        let title = 'Add to Home Screen';

        if (isIOS) {
          title = 'Install on iOS';
          instructions = 'To install this app on your iOS device:<br><br>' +
            '1. Tap the <strong>Share</strong> button <i class="fa-solid fa-square-arrow-up"></i><br>' +
            '2. Scroll down and tap <strong>"Add to Home Screen"</strong> <i class="fa-solid fa-plus-square"></i><br>' +
            '3. Tap <strong>"Add"</strong> to confirm';
        } else if (isAndroid) {
          title = 'Install on Android';
          instructions = 'To install this app on your Android device:<br><br>' +
            '1. Tap the <strong>menu</strong> button (⋮)<br>' +
            '2. Tap <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong><br>' +
            '3. Tap <strong>"Add"</strong> or <strong>"Install"</strong> to confirm';
        } else if (isBrave && isMac) {
          title = 'Install on Brave (macOS)';
          instructions = 'To install this app in Brave on macOS:<br><br>' +
            '1. Click the <strong>Install</strong> icon in the address bar (if shown), or<br>' +
            '2. Open the <strong>Brave menu</strong> (≡) → <strong>Apps</strong> → <strong>Install this site as an app…</strong><br>' +
            '3. Confirm <strong>Install</strong>';
        } else {
          instructions = 'To add this app to your device:<br><br>' +
            '• Look for an "Install" or "Add to Home Screen" option in your browser menu<br>' +
            '• The app will then be available from your home screen<br>' +
            '• You can use it offline and it will remember your progress';
        }

        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: title,
            html: instructions,
            icon: 'info',
            confirmButtonText: 'Got it!'
          });
        } else {
          alert(title + '\n\n' + instructions.replace(/<[^>]*>/g, ''));
        }
      }

      // Attach SweetAlert2 info for moving data to the cloud
      const moveBtn = document.getElementById("move-data-to-cloud-btn");
      if (moveBtn) {
        moveBtn.addEventListener("click", function (e) {
          e.preventDefault();

          {% if request.user.is_authenticated %}

            function send_json_to_backend(data_bundle, url) {

              fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                  data: data_bundle,
                  source: 'cloud_upload',
                  timestamp: new Date().toISOString()
                })
              })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  return response.json();
                })
                .then(data => {
                  // Handle successful response
                  Swal.fire({
                    title: 'Success!',
                    text: 'Your data has been uploaded to the cloud',
                    icon: 'success'
                  });

                  // Optional: Clear local data or redirect
                  // window.localStorage.removeItem('your_local_data_key');
                  // window.location.href = '/success-page/';
                })
                .catch(error => {
                  console.error('Error:', error);

                  // Show error message
                  Swal.fire({
                    title: 'Upload Failed',
                    text: 'There was a problem uploading your data. Please try again.',
                    icon: 'error'
                  });
                });
            }




            Swal.fire({
              title: "Move data to the cloud",
              html: "This will create a copy in the cloud of your locally stored data. Proceed?",
              confirmButtonText: "OK"
            }).then((result) => {
              if (result.isConfirmed) {

                let data_bundle = {'notes_history' :JSON.parse(JSON.stringify(window.progress_data || []))};
                data_bundle['info'] = {
                  instrument: '{{ instrument }}',
                  level: '{{ level }}',
                  clef: '{{ clef }}',
                  shifted_octave: '{{ octave }}',
                  key: '{{ key }}',
                  absolute_pitch: '{{absolute_pitch }}'
                }
                  send_json_to_backend(data_bundle, '{% url 'cache-to-backend' %}');
              }
            });

          {% else %}
            Swal.fire({
              title: "Move data to the cloud",
              html: "To move your data to the cloud, please <a href={% url 'account_signup' %}>create an account</a> or <a href='{% url 'account_login' %}'>sign in</a>. " +
                "Once your account is set up, we will ask you if you want to move your cache practice data to the cloud.",
              confirmButtonText: "OK"
            });
          {% endif %}
        });
      }
    });
  </script>


{% endblock cardbody %}

{% block timeup %}
  <div class="card z-3 shadow text-bg-secondary bg-gradient" id="time-up" style="display: none;">
    <script>
      // only do the below if we are in an iframe (frontpage)
      if (window.top !== window.self) {
        window.addEventListener('countdown_completed', () => {
          const card = document.getElementById("time-up");
          card.style.display = 'block';
        });
      }
    </script>

    <div class="card-body position-relative">
      <button type="button"
              class="btn-close btn-close-white position-absolute top-0 end-0 m-2"
              aria-label="Close"
              onclick="document.getElementById('time-up').remove()">
      </button>

      <h5 class="card-title">
        <i class="fa-regular fa-clock me-2"></i>To continue practising, close this popup. Or...
      </h5>

      <div class="d-flex flex-column gap-4">

        <div class="option-block">
          <!-- Loading indicator -->
          {% with link_css="fw-bold link-light link-underline-opacity-50 link-underline-opacity-100-hover" %}

            To move your practice data to the cloud (see the rest of this page of why this is a good idea!), please
            <a class='{{ link_css }}' href="{% url 'account_signup' %}">create an account</a> or
            <a class='{{ link_css }}' href='{% url 'account_login' %}'>sign in</a>. We will then ask for your permission
            to upload your data.

            </div>

            <div class="option-block">
              Alternatively you can practice whenever you want, where you left of, by visiting <a class="{{ link_css }}"
                                                                                                  target="_blank"
                                                                                                  href="{{ request.build_absolute_uri }}">this
              page</a>.

            </div>
          {% endwith link_css %}
      </div>
    </div>
  </div>{% endblock timeup %}

{% block cardheader %}
  <!-- Button to trigger modal -->
  <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="modal" data-bs-target="#settingsModal">
    <i class="fa-solid fa-edit"></i> {{ instrument }},
    {{ level }}{% if key != absolute_pitch %}, absolute pitch {{ absolute_pitch }}{% endif %}
  </button>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Music settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form id="musicSettingsForm">
          <div class="modal-body">

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="instrument-tab" data-bs-toggle="tab"
                        data-bs-target="#instrument" type="button" role="tab"
                        aria-controls="instrument" aria-selected="true">
                  Instrument
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="key-tab" data-bs-toggle="tab"
                        data-bs-target="#key" type="button" role="tab"
                        aria-controls="key" aria-selected="false">
                  Key
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="level-tab" data-bs-toggle="tab"
                        data-bs-target="#level" type="button" role="tab"
                        aria-controls="level" aria-selected="false">
                  Level
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="clef-tab" data-bs-toggle="tab"
                        data-bs-target="#clef" type="button" role="tab"
                        aria-controls="clef" aria-selected="false">
                  Clef
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="absolute-pitch-tab" data-bs-toggle="tab"
    data-bs-target="#absolute-pitch" type="button" role="tab"
    aria-controls="absolute-pitch" aria-selected="false">
    Absolute pitch
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="octave-tab" data-bs-toggle="tab"
                        data-bs-target="#octave" type="button" role="tab"
                        aria-controls="octave" aria-selected="false">
                  Octave shift
                </button>
              </li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content bg-white p-3" id="settingsTabContent">

              <!-- Instrument -->
              <div class="tab-pane fade show active" id="instrument" role="tabpanel"
                   aria-labelledby="instrument-tab">
                <div class="d-flex flex-wrap gap-3 bg-white">
                  {% for my_instrument in instruments %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="instrument"
                             id="instrument-{{ forloop.counter }}"
                             value="{{ my_instrument }}"
                             {% if my_instrument == instrument %}checked{% endif %}>
                      <label class="form-check-label text-dark"
                             for="instrument-{{ forloop.counter }}">
                        {{ my_instrument }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <!-- Level -->
              <div class="tab-pane fade" id="level" role="tabpanel" aria-labelledby="level-tab">
                <div class="d-flex flex-wrap gap-3 bg-white">
                  {% for my_level in levels %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="level"
                             id="level-{{ forloop.counter }}"
                             value="{{ my_level }}"
                             {% if my_level == level %}checked{% endif %}>
                      <label class="form-check-label text-dark"
                             for="level-{{ forloop.counter }}">
                        {{ my_level }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <!-- Clef -->
              <div class="tab-pane fade" id="clef" role="tabpanel" aria-labelledby="clef-tab">
                <div class="d-flex flex-wrap gap-3 bg-white">

                  {% for my_clef in clefs %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="clef"
                             id="clef-{{ forloop.counter }}"
                             value="{{ my_clef }}"
                             {% if my_clef|lower == clef %}checked{% endif %}>
                      <label class="form-check-label text-dark"
                             for="clef-{{ forloop.counter }}">
                        {{ my_clef }}
                      </label>
                    </div>
                  {% endfor %}

                <p class="bg-white text-dark mb-0 pb-0">Shift written notes up or down octaves?</p>
                  {% include 'notes/components/_octaves.html' with suffix_id='_in_octave_menu' %}
                </div>
              </div>

              <!-- Absolute pitch -->
              <div class="tab-pane fade" id="absolute-pitch" role="tabpanel" aria-labelledby="absolute-pitch-tab">
                <div class="d-flex flex-wrap gap-3 bg-white">
                  {% for my_key in keys %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="absolute-pitch"
                             id="absolute-pitch-{{ forloop.counter }}"
                             value="{{ my_key }}"
                             {% if my_key == absolute_pitch %}checked{% endif %}>
                      <label class="form-check-label text-dark"
                             for="absolute-pitch-{{ forloop.counter }}">
                        Absolute pitch: {{ my_key }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <!-- Key -->
              <div class="tab-pane fade" id="key" role="tabpanel" aria-labelledby="key-tab">
                <div class="d-flex flex-wrap gap-3 bg-white">
                  {% for my_key in keys %}
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="original_key"
                             id="original-key-{{ forloop.counter }}"
                             value="{{ my_key }}"
                             {% if my_key == key %}checked{% endif %}>
                      <label class="form-check-label text-dark"
                             for="original-key-{{ forloop.counter }}">
                        Key: {{ my_key }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <!-- Octave -->
              <div class="tab-pane fade" id="octave" role="tabpanel" aria-labelledby="octave-tab">
                <div class="d-flex flex-wrap gap-3 bg-white">
                  <p class="bg-white text-dark">Shift written notes up or down octaves?</p>
                  {% include 'notes/components/_octaves.html' %}
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Apply settings</button>
          </div>
        </form>

        <script>
          document.getElementById('musicSettingsForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            let instrument = formData.get('instrument') || '{{ instrument }}';
            instrument = instrument.replace(' ', '-');
            const level = formData.get('level') || '{{ level }}';
            const clef = formData.get('clef') || '{{ clef }}';
            const absolutePitch = formData.get('absolute-pitch') || '{{ absolute_pitch }}';
            const shifted_octave = formData.get('octave') || '{{ octave }}';

            let key = formData.get('original_key') || '{{ key }}';

            key = key.replace('#', 'sharp');
            key = key.replace('b', 'flat');

            let abs_pitch = String(absolutePitch || '');
            abs_pitch = abs_pitch.replace('#', 'sharp');
            abs_pitch = abs_pitch.replace('b', 'flat');

            const url = "{% url 'practice-try' instrument='INSTRUMENT' clef='CLEF' key='KEY' absolute_pitch='ABSOLUTE_PITCH' level='LEVEL' octave='SHIFTED_OCTAVE' %}"
              .replace('INSTRUMENT', instrument)
              .replace('CLEF', clef)
              .replace('KEY', key)
              .replace('ABSOLUTE_PITCH', abs_pitch)
              .replace('LEVEL', level)
              .replace('SHIFTED_OCTAVE', shifted_octave);

            window.location.href = url;
          });
        </script>
        <script>
          (function () {

            function slugify(name) {
              return String(name || '')
                .trim()
                .toLowerCase()
                .replace(/[_\s]+/g, '-')
                .replace(/-+/g, '-');
            }

            function getInstrumentInfo(instrumentName) {
              const slug = slugify(instrumentName);
              const dict = window.instrument_defaults || {};
              return (
                dict[slug] ||
                dict[instrumentName] ||
                dict[instrumentName?.toLowerCase?.()] ||
                null
              );
            }

            function findFirstMatchingRadio(radioNodeList, preferredValues) {
              // Try preferred values (case-insensitive) in order

              for (const pref of preferredValues) {
                const match = Array.from(radioNodeList).find(r =>
                  String(r.value).toLowerCase() === String(pref).toLowerCase()
                );
                if (match) return match;
              }
              return null;
            }

            function selectRadioIfDifferent(inputEl) {
              if (!inputEl || inputEl.checked) return;
              inputEl.checked = true;
              inputEl.dispatchEvent(new Event('change', {bubbles: true}));
            }

            function selectClefForInstrument(instrumentName) {
              const info = getInstrumentInfo(instrumentName);
              if (!info || !Array.isArray(info.clefs)) return;

              const clefRadios = document.querySelectorAll('input[name="clef"]');
              if (!clefRadios.length) return;

              const toSelect = findFirstMatchingRadio(clefRadios, info.clefs);
              if (toSelect) selectRadioIfDifferent(toSelect);
            }

            function selectKeyForInstrument(instrumentName) {
              const info = getInstrumentInfo(instrumentName);
              if (!info || !Array.isArray(info.keys)) return;

              for (const el_name of ['transpose-key', 'original_key']) {
                const keyRadios = document.querySelectorAll(`input[name="${el_name}"]`);
                if (!keyRadios.length) continue;

                // Prefer the instrument’s default keys in order; fall back to first available if none match
                let toSelect = findFirstMatchingRadio(keyRadios, info.keys);
                if (!toSelect) toSelect = keyRadios[0];
                if (toSelect) selectRadioIfDifferent(toSelect);
              }
            }

            function applyDefaultsForInstrument(instrumentName) {
              selectClefForInstrument(instrumentName);
              selectKeyForInstrument(instrumentName);
            }

            function getCheckedInstrumentValue() {
              const checked = document.querySelector('input[name="instrument"]:checked');
              return checked ? checked.value : null;
            }

            function bindInstrumentListeners() {
              const instrumentRadios = document.querySelectorAll('input[name="instrument"]');
              instrumentRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                  if (e.target && e.target.checked) {
                    applyDefaultsForInstrument(e.target.value);
                  }
                });
              });
            }

            document.addEventListener('DOMContentLoaded', function () {
              bindInstrumentListeners();
              const initialInstrument = getCheckedInstrumentValue();
              if (initialInstrument) {
                applyDefaultsForInstrument(initialInstrument);
              }
            });
          })();
        </script>
      </div>
    </div>
  </div>

  {% include 'notes/components/practice_dropdown_menu_right.html' %}
{% endblock cardheader %}

{% block see_results %}
  <a id="see-results" class="btn btn-link btn-xs text-start p-0 m-0">Stop and see your results</a>
  <script>
    document.getElementById('see-results').addEventListener('click', () => {
      fetch("{% url 'learningscenario_graph_try' instrument level %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': "{{ csrf_token }}"
        },
        body: JSON.stringify(window.progress_data)
      })
        .then(res => res.redirected ? window.location.href = res.url : res.text())
        .then(html => {
          if (html) {
            document.open();
            document.write(html);
            document.close();
          }
        })
        .catch(err => console.error('Error:', err));
    });
  </script>
{% endblock see_results %}

{% block navbar %}{% endblock navbar %}
{% block messages %}{% endblock messages %}

