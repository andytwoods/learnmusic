{% extends 'notes/practice.html' %}
{% load static %}

{% block css %}

  {{ block.super }}
  <style>
.dropdown-submenu {
    position: relative;
}

.dropdown-submenu .dropdown-menu {
    position: absolute;
    top: 0;
    left: 100%;  /* This makes it appear to the right */
    margin-top: -1px;
    margin-left: -1px;
}

/* Optional: Show submenu on hover */
.dropdown-submenu:hover > .dropdown-menu {
    display: block;
}

  </style>
{% endblock css %}

{% block bodyclass %}
  bg-light
{% endblock %}

{% block timeup %}
  <div class='card z-3 shadow text-bg-primary' id="time-up" style="display: none;">
    <div class='card-body'>
      <button type='button' class='btn-close position-absolute top-0 end-0 m-2' aria-label='Close'
              onclick='document.getElementById("time-up").remove()'></button>
      <p><strong>Timeâ€™s up!</strong></p>
      <p>To continue practicing, close this popup.</p>

      <p>
        <button class="btn btn-dark btn-sm">Save to cache</button>
        Want to save your progress without signing up?
        Pick this option to save to cache and go to a page you
        can bookmark. There you can practice whenever you want, and this message wont pop up.
      </p>
      <p>
        <button class="btn btn-dark btn-sm">Save with app</button>
        Select this option to save your progress through this app, and get access to a whole host of features such as
        progress reports, reminders, etc. This requires signing up. Unless costs mount, this app will remain free.
      </p>
      <p>
        {% include 'phrase.html' with fullstop=True %}
      </p>
    </div>
  </div>
{% endblock timeup %}

{% block cardheader %}

  <script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.dropdown-submenu .dropdown-toggle').forEach(function(element) {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            let submenu = this.nextElementSibling;
            let isOpen = submenu.classList.contains('show');

            // Close all other submenus
            document.querySelectorAll('.dropdown-submenu .dropdown-menu').forEach(function(menu) {
                menu.classList.remove('show');
            });

            if (!isOpen) {
                submenu.classList.add('show');
            }
        });
    });
});
  </script>
  <div class="dropdown">
    <button class="btn btn-light btn-xs p-0 dropdown-toggle" type="button" id="dropdownMenuCog"
            data-bs-toggle="dropdown" aria-expanded="false">
      <i class="fa-solid fa-music"></i> {{ instrument }},
      {{ level }}{% if key != transpose_key %}, transposing to {{ transpose_key }}{% endif %}
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuCog">
      <!-- Instrument Section -->
      <li class="dropdown-submenu">
        <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">
          Instrument
        </a>
        <ul class="dropdown-menu dropdown-menu-start">
          {% for my_instrument in instruments %}
            <li>
              <a class="dropdown-item {% if my_instrument == instrument %}active{% endif %}"
                 href="{% url 'practice-try' instrument=my_instrument clef=clef key=key level=level %}">
                {{ my_instrument }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </li>

      <!-- Level Section -->
      <li class="dropdown-submenu">
        <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">
          Level
        </a>
        <ul class="dropdown-menu dropdown-menu-start">
          {% for my_level in levels %}
            <li>
              <a class="dropdown-item {% if my_level == level %}active{% endif %}"
                 href="{% url 'practice-try' instrument=instrument clef=clef key=key level=my_level %}">
                {{ my_level }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </li>

      <!-- Clef Section -->
      <li class="dropdown-submenu">
        <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">
          Clef
        </a>
        <ul class="dropdown-menu dropdown-menu-start">
          {% for my_clef in clefs %}
            <li>
              <a class="dropdown-item {% if my_clef == clef %}active{% endif %}"
                 href="{% url 'practice-try' instrument=instrument clef=my_clef key=key level=level %}">
                {{ my_clef }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </li>

      <!-- Key Section -->
      <li class="dropdown-submenu">
        <a class="dropdown-item dropdown-toggle" href="#" data-bs-toggle="dropdown">
          Transpose to
        </a>
        <ul class="dropdown-menu dropdown-menu-start">
          {% for my_key in keys %}
            <li>
              <a class="dropdown-item {% if my_key == transpose_key %}active{% endif %}"
                 href="{% url 'practice-try' instrument=instrument clef=clef key=my_key level=level %}">
                Key: {{ my_key }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </li>
    </ul>
  </div>
  {% include 'notes/components/practice_dropdown_menu_right.html' %}
{% endblock cardheader %}

{% block see_results %}
  <a id="see-results" class="btn btn-link btn-xs text-start p-0 m-0">Stop and see your results
  </a>
  <script>
    document.getElementById('see-results').addEventListener('click', () => {

      fetch("{% url 'learningscenario_graph_try' instrument level %}", {
        method: 'POST', // HTTP method
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': "{{ csrf_token }}"
        },
        body: JSON.stringify(window.progress_data) // Convert the list to JSON format
      })
        .then(response => {
          if (response.redirected) {
            // If the backend sends a redirect, navigate to the returned location
            window.location.href = response.url;
          } else {
            return response.text(); // Get the response as text (full HTML in this case)
          }
        })
        .then(data => {
          if (data) {
            document.open();
            document.write(data);
            document.close();
          }
        })
        .catch(error => {
          console.error("Error:", error);
        });
    })
  </script>

{% endblock see_results %}




{% block navbar %}{% endblock navbar %}
{% block messages %}{% endblock messages %}
